import os
import hashlib

# Get Current Directory
curDir = os.path.dirname(__file__)

# Get Current Drive Letter
letFinder = os.path.splitdrive(curDir)
driveLetter = letFinder[0]


# Malicious Hashes
hashes = (curDir + '\\SHA256-Hashes.txt')

# Malicious Files
mfiles = []

def scanner(directory):
    for root, dirs, files in os.walk(directory, topdown=False):
        for name in files:
            if checker(hasher(os.path.join(root, name))) == True:
                mfiles.append(os.path.join(root, name))

def hasher(filepath):
    sh = hashlib.sha256()
    with open(filepath,'rb') as file:
        chunk = 0
        while chunk != b'':
            # read only 1024 bytes at a time
            chunk = file.read(1024)
            sh.update(chunk)
    return sh.hexdigest()

def checker(foundHash):
    with open(hashes,'r') as h:
        lines = [line.rstrip() for line in h]
        for line in lines:
            if str(foundHash) == str(line.split(";")[0]):
                return True
        h.close()
    return False

def deleter():
    for m in mfiles:
        os.remove(m)

# Main Function
def main():
    print("Running Scan of Computer for Infected Files")
    print("What Files Would You Like To Scan?")
    print("1: Just Files in Documents, Downloads, Videos, Pictures, and Desktop - FAST")
    print("2: Scan All Files - SLOW")
    inp2 = input("Select an option (1 or 2)")
    if inp2 == "1":
        scanner(driveLetter)
    elif inp2 == "2":
        scanner(os.path.join(os.path.join(os.environ['USERPROFILE']), 'Documents'))
        scanner(os.path.join(os.path.join(os.environ['USERPROFILE']), 'Desktop'))
        scanner(os.path.join(os.path.join(os.environ['USERPROFILE']), 'Downloads'))
        scanner(os.path.join(os.path.join(os.environ['USERPROFILE']), 'Pictures'))
        scanner(os.path.join(os.path.join(os.environ['USERPROFILE']), 'Videos'))
    else:
        print("Not A Valid Input, Try Again")
        return
    if mfiles != []:
        print("Malicious Files Found, Do you Wish to Delete or Show them?")
        run = True
        while run == True:
            print("1: Show Files")
            print("2: Delete Files")
            print("3: Exit Program")
            inp = input("Select an option (1, 2, or 3)")
            if inp == "3":
                run = False
            elif inp == "1":
                for m in mfiles:
                    print(m)
            elif inp == "2":
                deleter()
                print("File Deleted, Exiting Scanner")
                run = False
            else:
                print("No Valid Input: Try Again")
    else:
        print("No Malicious Files Found!")

# Run Main Function
if __name__ == '__main__':
    main()